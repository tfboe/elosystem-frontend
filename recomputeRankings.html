<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recompute Rankings</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
  <form id="loginForm">
    E-Mail: <input title="E-Mail" name="email" type="text"/> <br>
    Password: <input title="Password" name="password" type="password"/> <br>
    <input type="submit" value="Recompute"/>
</form>
<div id="output-div"></div>
<script>
  function getJsonFromForm(form) {
    const values = form.serializeArray();
    let res = {};
    for (let i = 0; i < values.length; i++) {
      res[values[i].name] = values[i].value;
    }
    return res;
  }
  base_url = "http://localhost:8000";
  $('#loginForm').on('submit', function () {
      const input = getJsonFromForm($('#loginForm'));
      $('#output-div').text("Logging in ...");
      $.ajax({
        url: base_url + "/login",
        method: "POST",
        data: JSON.stringify(input),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (response, textStatus, jqXHR) {
          const token = jqXHR.getResponseHeader('jwt-token');
          $('#output-div').html("Logging in ... success<br>Recalculate rankings ... ");
          $.ajax({
            url: base_url + "/recalculateRankings",
            method: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            contentType: false,
            processData: false,
            timeout: 3600000,
            headers: {'Authorization': 'bearer ' + token},
            success: function (response) {
              $('#output-div').html("Logging in ... success<br>Recalculate rankings ... done<br>Success: " + response.toString());
            },
            error: function (jqXHR, textStatus, errorThrown) {
              console.log(jqXHR);
              console.log(textStatus);
              console.log(errorThrown);
              $('#output-div').text("Error during recompute: " + jqXHR.responseText);
            }
          });
        },
        error: function (jqXHR, textStatus, errorThrown) {
          console.log(jqXHR);
          console.log(textStatus);
          console.log(errorThrown);
          $('#output-div').text("Error during login: " + jqXHR.responseJSON.message);
        }
      });
      return false;
  });
</script>
</body>
</html>
